<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: OptionLab::BinomialTree
  
    &mdash; OptionLab Documentation
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "OptionLab::BinomialTree";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (B)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../OptionLab.html" title="OptionLab (module)">OptionLab</a></span></span>
     &raquo; 
    <span class="title">BinomialTree</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: OptionLab::BinomialTree
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/option_lab/binomial_tree.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Implementation of the Cox-Ross-Rubinstein (CRR) binomial tree model
for American and European options pricing</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_greeks-class_method" title="get_greeks (class method)">.<strong>get_greeks</strong>(option_type, s0, x, r, volatility, years_to_maturity, n_steps = 100, is_american = true, dividend_yield = 0.0)  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Calculate option Greeks using the CRR model and finite difference methods.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_tree-class_method" title="get_tree (class method)">.<strong>get_tree</strong>(option_type, s0, x, r, volatility, years_to_maturity, n_steps = 15, is_american = true, dividend_yield = 0.0)  &#x21d2; Hash </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Get a full binomial tree as a structured output.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#option_payoff-class_method" title="option_payoff (class method)">.<strong>option_payoff</strong>(option_type, stock_price, strike)  &#x21d2; Float </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Calculate option payoff at expiration.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#price_option-class_method" title="price_option (class method)">.<strong>price_option</strong>(option_type, s0, x, r, volatility, years_to_maturity, n_steps = 100, is_american = true, dividend_yield = 0.0)  &#x21d2; Float </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Price an option using the Cox-Ross-Rubinstein binomial tree model.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="get_greeks-class_method">
  
    .<strong>get_greeks</strong>(option_type, s0, x, r, volatility, years_to_maturity, n_steps = 100, is_american = true, dividend_yield = 0.0)  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Calculate option Greeks using the CRR model and finite difference methods</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>option_type</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>&#39;call&#39; or &#39;put&#39;</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>s0</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Spot price</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>x</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Strike price</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>r</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Risk-free interest rate</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>volatility</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Volatility</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>years_to_maturity</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Time to maturity in years</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>n_steps</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>100</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Number of time steps</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>is_american</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>True for American options, false for European</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dividend_yield</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0.0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Continuous dividend yield</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Option Greeks (delta, gamma, theta, vega, rho)</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/option_lab/binomial_tree.rb', line 190</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_greeks'>get_greeks</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>=</span> <span class='int'>100</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span> <span class='op'>=</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span> <span class='op'>=</span> <span class='float'>0.0</span><span class='rparen'>)</span>
  <span class='comment'># Small increment for finite difference calculation
</span>  <span class='id identifier rubyid_h_s'>h_s</span> <span class='op'>=</span> <span class='id identifier rubyid_s0'>s0</span> <span class='op'>*</span> <span class='float'>0.001</span>    <span class='comment'># For Delta and Gamma
</span>  <span class='id identifier rubyid_h_t'>h_t</span> <span class='op'>=</span> <span class='float'>1.0</span> <span class='op'>/</span> <span class='int'>365</span>     <span class='comment'># For Theta (1 day)
</span>  <span class='id identifier rubyid_h_v'>h_v</span> <span class='op'>=</span> <span class='float'>0.001</span>         <span class='comment'># For Vega
</span>  <span class='id identifier rubyid_h_r'>h_r</span> <span class='op'>=</span> <span class='float'>0.0001</span>        <span class='comment'># For Rho
</span>
  <span class='comment'># Base price
</span>  <span class='id identifier rubyid_price'>price</span> <span class='op'>=</span> <span class='id identifier rubyid_price_option'>price_option</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span><span class='rparen'>)</span>

  <span class='comment'># Delta: ∂V/∂S
</span>  <span class='id identifier rubyid_price_up'>price_up</span> <span class='op'>=</span> <span class='id identifier rubyid_price_option'>price_option</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span> <span class='op'>+</span> <span class='id identifier rubyid_h_s'>h_s</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_price_down'>price_down</span> <span class='op'>=</span> <span class='id identifier rubyid_price_option'>price_option</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span> <span class='op'>-</span> <span class='id identifier rubyid_h_s'>h_s</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_delta'>delta</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_price_up'>price_up</span> <span class='op'>-</span> <span class='id identifier rubyid_price_down'>price_down</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='lparen'>(</span><span class='int'>2</span> <span class='op'>*</span> <span class='id identifier rubyid_h_s'>h_s</span><span class='rparen'>)</span>

  <span class='comment'># Gamma: ∂²V/∂S²
</span>  <span class='id identifier rubyid_gamma'>gamma</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_price_up'>price_up</span> <span class='op'>-</span> <span class='int'>2</span> <span class='op'>*</span> <span class='id identifier rubyid_price'>price</span> <span class='op'>+</span> <span class='id identifier rubyid_price_down'>price_down</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='lparen'>(</span><span class='id identifier rubyid_h_s'>h_s</span> <span class='op'>*</span> <span class='id identifier rubyid_h_s'>h_s</span><span class='rparen'>)</span>

  <span class='comment'># Theta: -∂V/∂t
</span>  <span class='id identifier rubyid_price_t_down'>price_t_down</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span> <span class='op'>-</span> <span class='id identifier rubyid_h_t'>h_t</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_price_option'>price_option</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span> <span class='op'>-</span> <span class='id identifier rubyid_h_t'>h_t</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_option_payoff'>option_payoff</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_theta'>theta</span> <span class='op'>=</span> <span class='op'>-</span><span class='lparen'>(</span><span class='id identifier rubyid_price_t_down'>price_t_down</span> <span class='op'>-</span> <span class='id identifier rubyid_price'>price</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='id identifier rubyid_h_t'>h_t</span>

  <span class='comment'># Vega: ∂V/∂σ
</span>  <span class='id identifier rubyid_price_v_up'>price_v_up</span> <span class='op'>=</span> <span class='id identifier rubyid_price_option'>price_option</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span> <span class='op'>+</span> <span class='id identifier rubyid_h_v'>h_v</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_vega'>vega</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_price_v_up'>price_v_up</span> <span class='op'>-</span> <span class='id identifier rubyid_price'>price</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='id identifier rubyid_h_v'>h_v</span>

  <span class='comment'># Rho: ∂V/∂r
</span>  <span class='id identifier rubyid_price_r_up'>price_r_up</span> <span class='op'>=</span> <span class='id identifier rubyid_price_option'>price_option</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span> <span class='op'>+</span> <span class='id identifier rubyid_h_r'>h_r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rho'>rho</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_price_r_up'>price_r_up</span> <span class='op'>-</span> <span class='id identifier rubyid_price'>price</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='id identifier rubyid_h_r'>h_r</span>

  <span class='comment'># Return Greeks
</span>  <span class='lbrace'>{</span>
    <span class='label'>delta:</span> <span class='id identifier rubyid_delta'>delta</span><span class='comma'>,</span>
    <span class='label'>gamma:</span> <span class='id identifier rubyid_gamma'>gamma</span><span class='comma'>,</span>
    <span class='label'>theta:</span> <span class='id identifier rubyid_theta'>theta</span><span class='comma'>,</span>
    <span class='label'>vega:</span> <span class='id identifier rubyid_vega'>vega</span><span class='comma'>,</span>
    <span class='label'>rho:</span> <span class='id identifier rubyid_rho'>rho</span><span class='comma'>,</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_tree-class_method">
  
    .<strong>get_tree</strong>(option_type, s0, x, r, volatility, years_to_maturity, n_steps = 15, is_american = true, dividend_yield = 0.0)  &#x21d2; <tt>Hash</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Get a full binomial tree as a structured output</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>option_type</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>&#39;call&#39; or &#39;put&#39;</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>s0</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Spot price</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>x</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Strike price</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>r</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Risk-free interest rate</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>volatility</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Volatility</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>years_to_maturity</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Time to maturity in years</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>n_steps</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>15</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Number of time steps</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>is_american</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>True for American options, false for European</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dividend_yield</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0.0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Continuous dividend yield</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Tree structure with stock prices and option values</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/option_lab/binomial_tree.rb', line 102</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_tree'>get_tree</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>=</span> <span class='int'>15</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span> <span class='op'>=</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span> <span class='op'>=</span> <span class='float'>0.0</span><span class='rparen'>)</span>
  <span class='comment'># Calculate time step
</span>  <span class='id identifier rubyid_dt'>dt</span> <span class='op'>=</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span> <span class='op'>/</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>

  <span class='comment'># Calculate up and down factors
</span>  <span class='id identifier rubyid_u'>u</span> <span class='op'>=</span> <span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_exp'>exp</span><span class='lparen'>(</span><span class='id identifier rubyid_volatility'>volatility</span> <span class='op'>*</span> <span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_sqrt'>sqrt</span><span class='lparen'>(</span><span class='id identifier rubyid_dt'>dt</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_d'>d</span> <span class='op'>=</span> <span class='float'>1.0</span> <span class='op'>/</span> <span class='id identifier rubyid_u'>u</span>

  <span class='comment'># Calculate risk-neutral probability
</span>  <span class='id identifier rubyid_effective_r'>effective_r</span> <span class='op'>=</span> <span class='id identifier rubyid_r'>r</span> <span class='op'>-</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span>
  <span class='id identifier rubyid_p'>p</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_exp'>exp</span><span class='lparen'>(</span><span class='id identifier rubyid_effective_r'>effective_r</span> <span class='op'>*</span> <span class='id identifier rubyid_dt'>dt</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='id identifier rubyid_d'>d</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span> <span class='op'>-</span> <span class='id identifier rubyid_d'>d</span><span class='rparen'>)</span>

  <span class='comment'># Calculate discount factor
</span>  <span class='id identifier rubyid_discount'>discount</span> <span class='op'>=</span> <span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_exp'>exp</span><span class='lparen'>(</span><span class='op'>-</span><span class='id identifier rubyid_r'>r</span> <span class='op'>*</span> <span class='id identifier rubyid_dt'>dt</span><span class='rparen'>)</span>

  <span class='comment'># Initialize price tree
</span>  <span class='id identifier rubyid_stock_prices'>stock_prices</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_option_values'>option_values</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_exercise_flags'>exercise_flags</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span> <span class='kw'>false</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

  <span class='comment'># Fill stock price tree
</span>  <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
      <span class='id identifier rubyid_stock_prices'>stock_prices</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_s0'>s0</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='op'>**</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span> <span class='op'>-</span> <span class='id identifier rubyid_j'>j</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='op'>**</span><span class='id identifier rubyid_j'>j</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Calculate option values at expiration (i = n_steps)
</span>  <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
    <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_option_payoff'>option_payoff</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_stock_prices'>stock_prices</span><span class='lbracket'>[</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Work backwards through the tree
</span>  <span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_downto'>downto</span><span class='lparen'>(</span><span class='int'>0</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
      <span class='comment'># Expected value (European option value)
</span>      <span class='id identifier rubyid_expected_value'>expected_value</span> <span class='op'>=</span> <span class='id identifier rubyid_discount'>discount</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_p'>p</span> <span class='op'>*</span> <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>-</span> <span class='id identifier rubyid_p'>p</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span> <span class='op'>+</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_is_american'>is_american</span>
        <span class='comment'># For American options, compare with immediate exercise value
</span>        <span class='id identifier rubyid_exercise_value'>exercise_value</span> <span class='op'>=</span> <span class='id identifier rubyid_option_payoff'>option_payoff</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_stock_prices'>stock_prices</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='rparen'>)</span>

        <span class='kw'>if</span> <span class='id identifier rubyid_exercise_value'>exercise_value</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_expected_value'>expected_value</span>
          <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_exercise_value'>exercise_value</span>
          <span class='id identifier rubyid_exercise_flags'>exercise_flags</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_expected_value'>expected_value</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='comment'># For European options, use expected value
</span>        <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_expected_value'>expected_value</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Return tree structure
</span>  <span class='lbrace'>{</span>
    <span class='label'>stock_prices:</span> <span class='id identifier rubyid_stock_prices'>stock_prices</span><span class='comma'>,</span>
    <span class='label'>option_values:</span> <span class='id identifier rubyid_option_values'>option_values</span><span class='comma'>,</span>
    <span class='label'>exercise_flags:</span> <span class='id identifier rubyid_exercise_flags'>exercise_flags</span><span class='comma'>,</span>
    <span class='label'>parameters:</span> <span class='lbrace'>{</span>
      <span class='label'>option_type:</span> <span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span>
      <span class='label'>spot_price:</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span>
      <span class='label'>strike_price:</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span>
      <span class='label'>risk_free_rate:</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span>
      <span class='label'>volatility:</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span>
      <span class='label'>time_to_maturity:</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span>
      <span class='label'>steps:</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='comma'>,</span>
      <span class='label'>is_american:</span> <span class='id identifier rubyid_is_american'>is_american</span><span class='comma'>,</span>
      <span class='label'>dividend_yield:</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span><span class='comma'>,</span>
      <span class='label'>up_factor:</span> <span class='id identifier rubyid_u'>u</span><span class='comma'>,</span>
      <span class='label'>down_factor:</span> <span class='id identifier rubyid_d'>d</span><span class='comma'>,</span>
      <span class='label'>risk_neutral_probability:</span> <span class='id identifier rubyid_p'>p</span><span class='comma'>,</span>
    <span class='rbrace'>}</span><span class='comma'>,</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="option_payoff-class_method">
  
    .<strong>option_payoff</strong>(option_type, stock_price, strike)  &#x21d2; <tt>Float</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Calculate option payoff at expiration</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>option_type</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>&#39;call&#39; or &#39;put&#39;</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>stock_price</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Stock price</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>strike</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Strike price</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Option payoff</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


81
82
83
84
85
86
87
88
89</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/option_lab/binomial_tree.rb', line 81</span>

<span class='kw'>def</span> <span class='id identifier rubyid_option_payoff'>option_payoff</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_stock_price'>stock_price</span><span class='comma'>,</span> <span class='id identifier rubyid_strike'>strike</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_option_type'>option_type</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>call</span><span class='tstring_end'>&#39;</span></span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_stock_price'>stock_price</span> <span class='op'>-</span> <span class='id identifier rubyid_strike'>strike</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_option_type'>option_type</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>put</span><span class='tstring_end'>&#39;</span></span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_strike'>strike</span> <span class='op'>-</span> <span class='id identifier rubyid_stock_price'>stock_price</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Option type must be either &#39;call&#39; or &#39;put&#39;!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="price_option-class_method">
  
    .<strong>price_option</strong>(option_type, s0, x, r, volatility, years_to_maturity, n_steps = 100, is_american = true, dividend_yield = 0.0)  &#x21d2; <tt>Float</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Price an option using the Cox-Ross-Rubinstein binomial tree model</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>option_type</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>&#39;call&#39; or &#39;put&#39;</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>s0</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Spot price</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>x</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Strike price</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>r</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Risk-free interest rate</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>volatility</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Volatility</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>years_to_maturity</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Time to maturity in years</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>n_steps</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>100</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Number of time steps</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>is_american</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>true</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>True for American options, false for European</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>dividend_yield</span>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0.0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Continuous dividend yield</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Float</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Option price</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/option_lab/binomial_tree.rb', line 24</span>

<span class='kw'>def</span> <span class='id identifier rubyid_price_option'>price_option</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_s0'>s0</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='id identifier rubyid_r'>r</span><span class='comma'>,</span> <span class='id identifier rubyid_volatility'>volatility</span><span class='comma'>,</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span><span class='comma'>,</span> <span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>=</span> <span class='int'>100</span><span class='comma'>,</span> <span class='id identifier rubyid_is_american'>is_american</span> <span class='op'>=</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span> <span class='op'>=</span> <span class='float'>0.0</span><span class='rparen'>)</span>
  <span class='comment'># Calculate time step
</span>  <span class='id identifier rubyid_dt'>dt</span> <span class='op'>=</span> <span class='id identifier rubyid_years_to_maturity'>years_to_maturity</span> <span class='op'>/</span> <span class='id identifier rubyid_n_steps'>n_steps</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>

  <span class='comment'># Calculate up and down factors
</span>  <span class='id identifier rubyid_u'>u</span> <span class='op'>=</span> <span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_exp'>exp</span><span class='lparen'>(</span><span class='id identifier rubyid_volatility'>volatility</span> <span class='op'>*</span> <span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_sqrt'>sqrt</span><span class='lparen'>(</span><span class='id identifier rubyid_dt'>dt</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_d'>d</span> <span class='op'>=</span> <span class='float'>1.0</span> <span class='op'>/</span> <span class='id identifier rubyid_u'>u</span>

  <span class='comment'># Calculate risk-neutral probability
</span>  <span class='id identifier rubyid_effective_r'>effective_r</span> <span class='op'>=</span> <span class='id identifier rubyid_r'>r</span> <span class='op'>-</span> <span class='id identifier rubyid_dividend_yield'>dividend_yield</span>
  <span class='id identifier rubyid_p'>p</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_exp'>exp</span><span class='lparen'>(</span><span class='id identifier rubyid_effective_r'>effective_r</span> <span class='op'>*</span> <span class='id identifier rubyid_dt'>dt</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='id identifier rubyid_d'>d</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span> <span class='op'>-</span> <span class='id identifier rubyid_d'>d</span><span class='rparen'>)</span>

  <span class='comment'># Calculate discount factor
</span>  <span class='id identifier rubyid_discount'>discount</span> <span class='op'>=</span> <span class='const'>Math</span><span class='period'>.</span><span class='id identifier rubyid_exp'>exp</span><span class='lparen'>(</span><span class='op'>-</span><span class='id identifier rubyid_r'>r</span> <span class='op'>*</span> <span class='id identifier rubyid_dt'>dt</span><span class='rparen'>)</span>

  <span class='comment'># Initialize price tree
</span>  <span class='id identifier rubyid_stock_prices'>stock_prices</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_option_values'>option_values</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span> <span class='float'>0.0</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

  <span class='comment'># Fill stock price tree
</span>  <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
      <span class='id identifier rubyid_stock_prices'>stock_prices</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_s0'>s0</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='op'>**</span><span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span> <span class='op'>-</span> <span class='id identifier rubyid_j'>j</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span><span class='op'>**</span><span class='id identifier rubyid_j'>j</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Calculate option values at expiration (i = n_steps)
</span>  <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
    <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_option_payoff'>option_payoff</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_stock_prices'>stock_prices</span><span class='lbracket'>[</span><span class='id identifier rubyid_n_steps'>n_steps</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Work backwards through the tree
</span>  <span class='lparen'>(</span><span class='id identifier rubyid_n_steps'>n_steps</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_downto'>downto</span><span class='lparen'>(</span><span class='int'>0</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
    <span class='lparen'>(</span><span class='int'>0</span><span class='op'>..</span><span class='id identifier rubyid_i'>i</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_j'>j</span><span class='op'>|</span>
      <span class='comment'># Expected value (European option value)
</span>      <span class='id identifier rubyid_expected_value'>expected_value</span> <span class='op'>=</span> <span class='id identifier rubyid_discount'>discount</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_p'>p</span> <span class='op'>*</span> <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>-</span> <span class='id identifier rubyid_p'>p</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span> <span class='op'>+</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_is_american'>is_american</span>
        <span class='comment'># For American options, compare with immediate exercise value
</span>        <span class='id identifier rubyid_exercise_value'>exercise_value</span> <span class='op'>=</span> <span class='id identifier rubyid_option_payoff'>option_payoff</span><span class='lparen'>(</span><span class='id identifier rubyid_option_type'>option_type</span><span class='comma'>,</span> <span class='id identifier rubyid_stock_prices'>stock_prices</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_x'>x</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_expected_value'>expected_value</span><span class='comma'>,</span> <span class='id identifier rubyid_exercise_value'>exercise_value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_max'>max</span>
      <span class='kw'>else</span>
        <span class='comment'># For European options, use expected value
</span>        <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='id identifier rubyid_j'>j</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_expected_value'>expected_value</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Root node contains the option price
</span>  <span class='id identifier rubyid_option_values'>option_values</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Sun Apr 27 02:08:10 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.3.3).
</div>

    </div>
  </body>
</html>